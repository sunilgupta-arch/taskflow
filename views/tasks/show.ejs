<div class="row g-3">
  <div class="col-lg-8">
    <div class="tf-card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-file-text me-2"></i>TASK DETAILS</span>
        <div class="d-flex gap-2">
          <span class="badge badge-<%= task.type %>" style="font-size:0.65rem;border-radius:4px;padding:3px 8px;"><%= task.type %></span>
          <span class="badge badge-<%= task.status %>" style="font-size:0.65rem;border-radius:4px;padding:3px 8px;"><%= task.status.replace('_',' ') %></span>
        </div>
      </div>
      <div class="p-4">
        <h4 style="font-weight:600;margin-bottom:0.75rem;"><%= task.title %></h4>
        <p style="color:var(--tf-text-muted);font-size:0.9rem;line-height:1.7;"><%= task.description || 'No description provided.' %></p>
        
        <div class="row g-3 mt-2">
          <div class="col-6 col-md-3">
            <div style="font-size:0.65rem;color:var(--tf-text-muted);text-transform:uppercase;letter-spacing:0.5px;">Created By</div>
            <div style="font-size:0.875rem;margin-top:2px;"><%= task.created_by_name %></div>
          </div>
          <div class="col-6 col-md-3">
            <div style="font-size:0.65rem;color:var(--tf-text-muted);text-transform:uppercase;letter-spacing:0.5px;">Assigned To</div>
            <div style="font-size:0.875rem;margin-top:2px;"><%= task.assigned_to_name || 'Unassigned' %></div>
          </div>
          <div class="col-6 col-md-3">
            <div style="font-size:0.65rem;color:var(--tf-text-muted);text-transform:uppercase;letter-spacing:0.5px;">Due Date</div>
            <div style="font-size:0.875rem;margin-top:2px;"><%= task.due_date ? new Date(task.due_date).toLocaleDateString() : 'None' %></div>
          </div>
          <div class="col-6 col-md-3">
            <div style="font-size:0.65rem;color:var(--tf-text-muted);text-transform:uppercase;letter-spacing:0.5px;">Reward</div>
            <div style="font-size:0.875rem;margin-top:2px;font-family:var(--tf-font-mono);color:#f59e0b;">
              <%= task.reward_amount ? '$' + parseFloat(task.reward_amount).toFixed(2) : 'None' %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Attachments -->
    <div class="tf-card mb-3">
      <div class="card-header"><i class="bi bi-paperclip me-2"></i>ATTACHMENTS (<%= attachments.length %>)</div>
      <div class="p-3">
        <% if (attachments.length > 0) { %>
        <% attachments.forEach(a => { %>
        <div class="d-flex align-items-center gap-2 mb-2 p-2" style="background:var(--tf-surface-2);border-radius:6px;">
          <i class="bi bi-file-earmark" style="color:var(--tf-accent);"></i>
          <div class="flex-grow-1">
            <div style="font-size:0.8rem;font-weight:500;"><%= a.original_name %></div>
            <div style="font-size:0.7rem;color:var(--tf-text-muted);">
              By <%= a.uploaded_by_name %> Â· <%= new Date(a.created_at).toLocaleDateString() %>
            </div>
          </div>
          <a href="/uploads/tasks/<%= a.file_path %>" target="_blank" style="font-size:0.75rem;color:var(--tf-accent);">
            <i class="bi bi-download"></i>
          </a>
        </div>
        <% }) %>
        <% } else { %>
        <p style="color:var(--tf-text-muted);font-size:0.875rem;">No attachments yet</p>
        <% } %>
        
        <% if (['OUR_USER', 'OUR_MANAGER', 'OUR_ADMIN'].includes(user.role_name) && task.status !== 'completed') { %>
        <div class="mt-3" style="border-top:1px solid var(--tf-border);padding-top:1rem;">
          <label style="font-size:0.75rem;color:var(--tf-text-muted);display:block;margin-bottom:0.5rem;">UPLOAD FILES</label>
          <input type="file" id="fileInput" multiple style="display:none;" onchange="handleUpload()">
          <button class="btn-tf btn-tf-outline" onclick="document.getElementById('fileInput').click()">
            <i class="bi bi-upload me-1"></i> Upload Files
          </button>
        </div>
        <% } %>
      </div>
    </div>

    <!-- Remarks & Comments -->
    <div class="tf-card mb-3">
      <div class="card-header"><i class="bi bi-chat-dots me-2"></i>REMARKS & COMMENTS (<%= comments.length %>)</div>
      <div class="p-3">
        <% if (comments.length > 0) { %>
          <% const topLevel = comments.filter(c => !c.parent_id); %>
          <% topLevel.forEach(c => { %>
          <div class="mb-3" style="border-left:3px solid <%= c.org_type === 'CFC' ? 'var(--tf-accent)' : 'var(--tf-accent-2)' %>;padding-left:0.75rem;">
            <div class="d-flex align-items-center gap-2 mb-1">
              <div class="user-avatar" style="width:26px;height:26px;font-size:0.6rem;"><%= c.user_name.charAt(0) %></div>
              <span style="font-size:0.8rem;font-weight:600;"><%= c.user_name %></span>
              <span class="badge" style="font-size:0.55rem;padding:1px 5px;border-radius:3px;
                background:<%= c.org_type === 'CFC' ? 'rgba(0,212,255,0.1)' : 'rgba(124,58,237,0.1)' %>;
                color:<%= c.org_type === 'CFC' ? '#00d4ff' : '#a78bfa' %>;"><%= c.role_name %></span>
              <span style="font-size:0.65rem;color:var(--tf-text-muted);margin-left:auto;"><%= new Date(c.created_at).toLocaleString() %></span>
            </div>
            <p style="font-size:0.85rem;margin:0.25rem 0 0.5rem;color:var(--tf-text);line-height:1.5;"><%= c.comment %></p>
            <button class="btn-tf" style="font-size:0.6rem;padding:1px 6px;background:transparent;color:var(--tf-text-muted);border:1px solid var(--tf-border);"
              onclick="toggleReply(<%= c.id %>)">
              <i class="bi bi-reply me-1"></i>Reply
            </button>

            <!-- Reply form (hidden by default) -->
            <div id="replyForm-<%= c.id %>" style="display:none;margin-top:0.5rem;">
              <div class="d-flex gap-2">
                <input type="text" id="replyInput-<%= c.id %>" class="tf-form-control" placeholder="Write a reply..." style="font-size:0.8rem;">
                <button class="btn-tf btn-tf-primary" style="font-size:0.7rem;white-space:nowrap;" onclick="submitComment(<%= c.id %>)">Send</button>
              </div>
            </div>

            <!-- Replies -->
            <% const replies = comments.filter(r => r.parent_id === c.id); %>
            <% if (replies.length > 0) { %>
            <div style="margin-top:0.5rem;padding-left:0.75rem;border-left:1px solid var(--tf-border);">
              <% replies.forEach(r => { %>
              <div class="mb-2">
                <div class="d-flex align-items-center gap-2 mb-1">
                  <div class="user-avatar" style="width:22px;height:22px;font-size:0.55rem;"><%= r.user_name.charAt(0) %></div>
                  <span style="font-size:0.75rem;font-weight:600;"><%= r.user_name %></span>
                  <span class="badge" style="font-size:0.5rem;padding:1px 4px;border-radius:3px;
                    background:<%= r.org_type === 'CFC' ? 'rgba(0,212,255,0.1)' : 'rgba(124,58,237,0.1)' %>;
                    color:<%= r.org_type === 'CFC' ? '#00d4ff' : '#a78bfa' %>;"><%= r.role_name %></span>
                  <span style="font-size:0.6rem;color:var(--tf-text-muted);margin-left:auto;"><%= new Date(r.created_at).toLocaleString() %></span>
                </div>
                <p style="font-size:0.8rem;margin:0;color:var(--tf-text);line-height:1.4;"><%= r.comment %></p>
              </div>
              <% }) %>
            </div>
            <% } %>
          </div>
          <% }) %>
        <% } else { %>
        <p style="color:var(--tf-text-muted);font-size:0.875rem;">No remarks yet. Be the first to add one.</p>
        <% } %>

        <!-- New remark form -->
        <div style="margin-top:1rem;border-top:1px solid var(--tf-border);padding-top:1rem;">
          <label style="font-size:0.75rem;color:var(--tf-text-muted);display:block;margin-bottom:0.5rem;">ADD A REMARK</label>
          <div class="d-flex gap-2">
            <input type="text" id="newComment" class="tf-form-control" placeholder="Write a remark or update..." style="font-size:0.85rem;">
            <button class="btn-tf btn-tf-primary" style="white-space:nowrap;" onclick="submitComment()">
              <i class="bi bi-send me-1"></i> Post
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar Actions -->
  <div class="col-lg-4">
    <div class="tf-card">
      <div class="card-header"><i class="bi bi-lightning me-2"></i>ACTIONS</div>
      <div class="p-3 d-flex flex-column gap-2">
        <% if (user.role_name === 'OUR_USER' && task.assigned_to === user.id && task.status !== 'completed') { %>
        <button class="btn-tf btn-tf-success" onclick="completeTask()">
          <i class="bi bi-check-circle me-1"></i> Mark Complete
        </button>
        <% } %>
        
        <% if (!task.assigned_to && user.role_name === 'OUR_USER') { %>
        <button class="btn-tf btn-tf-primary" onclick="pickTask()">
          <i class="bi bi-hand-index me-1"></i> Pick This Task
        </button>
        <% } %>
        
        <a href="/tasks" class="btn-tf btn-tf-outline text-center text-decoration-none">
          <i class="bi bi-arrow-left me-1"></i> Back to Tasks
        </a>
      </div>
    </div>
    
    <div class="tf-card mt-3">
      <div class="card-header"><i class="bi bi-clock me-2"></i>TIMELINE</div>
      <div class="p-3">
        <div style="font-size:0.75rem;">
          <div class="mb-2">
            <span style="color:var(--tf-text-muted);">Created:</span>
            <span class="ms-1"><%= new Date(task.created_at).toLocaleString() %></span>
          </div>
          <% if (task.completed_at) { %>
          <div>
            <span style="color:var(--tf-text-muted);">Completed:</span>
            <span class="ms-1" style="color:#10b981;"><%= new Date(task.completed_at).toLocaleString() %></span>
          </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
async function completeTask() {
  if (!confirm('Mark this task as completed?')) return;
  try {
    await axios.post('/tasks/complete/<%= task.id %>');
    showToast('Task completed!');
    setTimeout(() => location.reload(), 800);
  } catch (e) {
    showToast(e.response?.data?.message || 'Error', 'error');
  }
}
async function pickTask() {
  try {
    await axios.post('/tasks/pick/<%= task.id %>');
    showToast('Task picked!');
    setTimeout(() => location.reload(), 800);
  } catch (e) {
    showToast(e.response?.data?.message || 'Error', 'error');
  }
}
async function handleUpload() {
  const files = document.getElementById('fileInput').files;
  if (!files.length) return;

  const formData = new FormData();
  for (const f of files) formData.append('files', f);

  try {
    await axios.post('/tasks/<%= task.id %>/upload', formData, {
      headers: { 'Content-Type': 'multipart/form-data' }
    });
    showToast('Files uploaded!');
    setTimeout(() => location.reload(), 800);
  } catch (e) {
    showToast('Upload failed', 'error');
  }
}
function toggleReply(commentId) {
  const form = document.getElementById('replyForm-' + commentId);
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
  if (form.style.display === 'block') {
    document.getElementById('replyInput-' + commentId).focus();
  }
}
async function submitComment(parentId) {
  let input, comment;
  if (parentId) {
    input = document.getElementById('replyInput-' + parentId);
  } else {
    input = document.getElementById('newComment');
  }
  comment = input.value.trim();
  if (!comment) return showToast('Please enter a comment', 'error');

  try {
    await axios.post('/tasks/<%= task.id %>/comments', { comment: comment, parent_id: parentId || null });
    showToast('Comment posted!');
    setTimeout(() => location.reload(), 600);
  } catch (e) {
    showToast(e.response?.data?.message || 'Error posting comment', 'error');
  }
}
</script>
